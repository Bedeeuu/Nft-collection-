name: Auto Image Descriptions

on:
  push:
    paths:
      - 'images/**/*.{jpg,jpeg,png,gif}'

jobs:
  describe-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      TELEGRAM_TOKEN:   ${{ secrets.TELEGRAM_TOKEN }}
      HF_TOKEN:         ${{ secrets.HF_TOKEN }}
      OPENAI_API_KEY:   ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN:     ${{ secrets.MY_TOKEN }}          # –µ—Å–ª–∏ –≤—ã –∑–∞–≤–æ–¥–∏–ª–∏ –µ–≥–æ –∫–∞–∫ MY_TOKEN
      GITHUB_REPO:      ${{ secrets.GITHUB_REPO }}       # –∏–ª–∏ —è–≤–Ω–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å owner/repo
      HF_TEXT_MODEL:    ${{ secrets.HF_TEXT_MODEL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install aiohttp python-dotenv aiogram PyGithub

      - name: Generate descriptions
        run: |
          # –ó–¥–µ—Å—å –≤–∞—à —Å–∫—Ä–∏–ø—Ç .github/scripts/generate_descriptions.py
          python .github/scripts/generate_descriptions.py

      - name: Commit & push generated files
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/*.txt
          git diff --quiet --exit-code \
            || git commit -m "üñºÔ∏è Auto-generate image descriptions" && git push
